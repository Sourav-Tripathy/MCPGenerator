# Zerodha Kite Connect MCP Server

This project provides a Model Context Protocol (MCP) server for interacting with the Zerodha Kite Connect v3 Orders API using FastMCP. It allows language models or other applications to manage trading orders (place, modify, cancel) and retrieve order/trade information through a standardized MCP interface.

## Features

*   Place various types of orders (regular, AMO, CO, Iceberg, Auction).
*   Modify existing pending orders (regular, CO).
*   Cancel pending orders.
*   Retrieve all orders for the day.
*   Retrieve the history (state transitions) of a specific order.
*   Retrieve all executed trades for the day.
*   Retrieve trades associated with a specific order.
*   Asynchronous API client built with `httpx`.
*   Input validation using Pydantic models.
*   Environment variable-based configuration for API credentials.
*   Basic error handling for API and network issues.

## Prerequisites

*   Python 3.8+
*   A Zerodha Kite Connect API Key and Secret.
*   A valid `access_token` generated through the Kite Connect login flow. **Note:** Access tokens are short-lived and need to be regenerated periodically (typically daily). This server assumes a valid token is provided via environment variables; it does not handle the token generation flow itself.

## Setup

1.  **Clone the repository:**
    ```bash
    git clone <repository_url>
    cd <repository_directory>
    ```

2.  **Create and activate a virtual environment:**
    ```bash
    python -m venv venv
    source venv/bin/activate  # On Windows use `venv\\Scripts\\activate`
    ```

3.  **Install dependencies:**
    ```bash
    pip install -r requirements.txt
    ```

4.  **Configure Environment Variables:**
    Create a `.env` file in the project root directory by copying the example file:
    ```bash
    cp .env.example .env
    ```
    Edit the `.env` file and replace the placeholder values with your actual Kite Connect API Key and a valid Access Token:
    ```dotenv
    # Zerodha Kite Connect API Credentials
    KITE_API_KEY="YOUR_ACTUAL_API_KEY"
    KITE_ACCESS_TOKEN="YOUR_VALID_ACCESS_TOKEN"
    KITE_BASE_URL="https://api.kite.trade"
    ```
    **Important:** Keep your `.env` file secure and do not commit it to version control.

## Running the Server

Start the MCP server using Uvicorn (which is called by `mcp.run()`):

```bash
python main.py
```

The server will start, typically listening on `http://127.0.0.1:8000` by default. You can configure the host and port in the `mcp.run()` call within `main.py` if needed.

## Available Tools (MCP Endpoints)

The server exposes the following tools callable via the MCP protocol:

1.  **`place_order(params: PlaceOrderParams)`**
    *   Description: Place an order of a particular variety.
    *   Input: `PlaceOrderParams` model (see `models.py` for fields like `variety`, `tradingsymbol`, `exchange`, `transaction_type`, `order_type`, `quantity`, `product`, `validity`, etc.).
    *   Returns: Dictionary with order ID on success, or error details.

2.  **`modify_order(params: ModifyRegularOrderParams)`**
    *   Description: Modify attributes of an open/pending regular or CO order.
    *   Input: `ModifyRegularOrderParams` model (see `models.py` for fields like `variety`, `order_id`, `quantity`, `price`, `trigger_price`, etc.).
    *   Returns: Dictionary with order ID on success, or error details.

3.  **`cancel_order(params: CancelOrderParams)`**
    *   Description: Cancel an open or pending order.
    *   Input: `CancelOrderParams` model (`variety`, `order_id`).
    *   Returns: Dictionary with order ID on success, or error details.

4.  **`get_orders()`**
    *   Description: Retrieve the list of all orders for the day.
    *   Input: None.
    *   Returns: Dictionary containing a list of order details, or error details.

5.  **`get_order_history(params: GetOrderHistoryParams)`**
    *   Description: Retrieve the history (state transitions) of a given order.
    *   Input: `GetOrderHistoryParams` model (`order_id`).
    *   Returns: Dictionary containing a list of order states, or error details.

6.  **`get_trades()`**
    *   Description: Retrieve the list of all executed trades for the day.
    *   Input: None.
    *   Returns: Dictionary containing a list of trade details, or error details.

7.  **`get_order_trades(params: GetOrderTradesParams)`**
    *   Description: Retrieve the trades generated by a specific order.
    *   Input: `GetOrderTradesParams` model (`order_id`).
    *   Returns: Dictionary containing a list of trade details for the order, or error details.

## Error Handling

The API client (`client.py`) includes error handling for:
*   HTTP errors (4xx, 5xx)
*   Network request errors
*   Kite Connect API specific errors (returned in the response body)
*   Pydantic validation errors

Errors are logged, and the MCP tools return a dictionary with an `"error"` key and details when issues occur.

## Rate Limiting

Zerodha Kite Connect imposes rate limits on API requests (e.g., 3 requests/second for order placement/modification/cancellation, 10 requests/second for data retrieval). This implementation uses `httpx` but **does not** have built-in automatic rate limiting handling. For applications requiring high request volumes, consider implementing rate limiting using libraries like `aiolimiter` or adding delays between requests.

## Disclaimer

Trading involves substantial risk. This software is provided "as is" without warranty of any kind. Use it at your own risk and ensure you understand the implications of automated trading before deploying it.
