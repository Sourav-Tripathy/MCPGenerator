# Kite Connect MCP Server

This project provides a Model Context Protocol (MCP) server for interacting with the Zerodha Kite Connect trading API (v3) using FastMCP.

It allows language models or other applications to perform trading-related actions like placing, modifying, and cancelling orders, as well as retrieving order and trade history through a standardized MCP interface.

## Features

*   Provides MCP tools for core Kite Connect functionalities:
    *   `place_order`: Place regular, AMO, CO, Iceberg, or Auction orders.
    *   `modify_order`: Modify pending regular or CO orders.
    *   `cancel_order`: Cancel pending orders.
    *   `get_orders`: Retrieve the list of orders for the day.
    *   `get_order_history`: Get status changes for a specific order.
    *   `get_trades`: Retrieve the list of executed trades for the day.
    *   `get_order_trades`: Get trades associated with a specific order.
*   Built with FastMCP for easy integration.
*   Asynchronous API client using `httpx`.
*   Typed inputs and outputs using Pydantic.
*   Handles API errors and provides informative responses.
*   Configurable via environment variables.

## Prerequisites

*   Python 3.8+
*   Zerodha Kite Connect API Key and Access Token.
You can get these by creating a Kite Connect app on the [Zerodha Developers Console](https://developers.kite.trade/).
*   Understanding that **access tokens are short-lived** and need to be regenerated (typically daily after login). This server assumes a valid access token is provided via environment variables. A production deployment would require a robust token generation/refresh mechanism.

## Setup

1.  **Clone the repository:**
    ```bash
    git clone <repository-url>
    cd kiteconnect-mcp-server
    ```

2.  **Create a virtual environment (recommended):**
    ```bash
    python -m venv venv
    source venv/bin/activate  # On Windows use `venv\\Scripts\\activate`
    ```

3.  **Install dependencies:**
    ```bash
    pip install -r requirements.txt
    ```

4.  **Configure Environment Variables:**
    Copy the example environment file:
    ```bash
    cp .env.example .env
    ```
    Edit the `.env` file and add your Kite Connect API Key and a valid Access Token:
    ```dotenv
    # .env
    KITE_API_KEY="YOUR_API_KEY"
    KITE_ACCESS_TOKEN="YOUR_VALID_ACCESS_TOKEN"
    # KITE_BASE_URL="https://api.kite.trade" # Optional
    ```
    **Important:** Ensure the `KITE_ACCESS_TOKEN` is fresh. You usually obtain this after completing the Kite Connect login flow.

## Running the Server

Use `uvicorn` to run the FastMCP application (which is a FastAPI app):

```bash
uvicorn main:mcp.app --host 0.0.0.0 --port 8000 --reload
```

*   `--host 0.0.0.0`: Makes the server accessible on your network.
*   `--port 8000`: Specifies the port to run on.
*   `--reload`: Automatically restarts the server when code changes (useful for development).

The MCP server will be available at `http://localhost:8000`.

## Available Tools

The server exposes the following tools via the MCP protocol:

*   **`place_order(params: PlaceOrderParams) -> Dict[str, Any]`**
    *   Description: Place an order of a particular variety.
    *   Input: `PlaceOrderParams` model (includes variety, tradingsymbol, exchange, transaction\_type, order\_type, quantity, product, etc.)
    *   Returns: Dictionary containing `order_id` on success, or an error dictionary.

*   **`modify_order(params: ModifyOrderParams) -> Dict[str, Any]`**
    *   Description: Modify attributes of a pending order.
    *   Input: `ModifyOrderParams` model (includes variety, order\_id, and fields to modify like quantity, price, trigger\_price).
    *   Returns: Dictionary containing `order_id` on success, or an error dictionary.

*   **`cancel_order(params: CancelOrderParams) -> Dict[str, Any]`**
    *   Description: Cancel a pending order.
    *   Input: `CancelOrderParams` model (includes variety, order\_id, parent\_order\_id).
    *   Returns: Dictionary containing `order_id` on success, or an error dictionary.

*   **`get_orders() -> List[Dict[str, Any]]`**
    *   Description: Retrieve all orders for the current trading day.
    *   Input: None.
    *   Returns: List of order dictionaries, or a list containing a single error dictionary.

*   **`get_order_history(params: GetOrderHistoryParams) -> List[Dict[str, Any]]`**
    *   Description: Retrieve the history for a specific order.
    *   Input: `GetOrderHistoryParams` model (includes order\_id).
    *   Returns: List of order state dictionaries, or a list containing a single error dictionary.

*   **`get_trades() -> List[Dict[str, Any]]`**
    *   Description: Retrieve all executed trades for the current trading day.
    *   Input: None.
    *   Returns: List of trade dictionaries, or a list containing a single error dictionary.

*   **`get_order_trades(params: GetOrderTradesParams) -> List[Dict[str, Any]]`**
    *   Description: Retrieve trades generated by a specific order.
    *   Input: `GetOrderTradesParams` model (includes order\_id).
    *   Returns: List of trade dictionaries, or a list containing a single error dictionary.

Refer to `models.py` for detailed structure of the input parameter models and `client.py` / Kite Connect documentation for the structure of the returned dictionaries.

## Error Handling

The API client (`client.py`) attempts to catch common HTTP errors and specific errors returned by the Kite Connect API. Errors are generally returned as a dictionary matching the `KiteApiErrorResponse` model:

```json
{
  "error_type": "AuthenticationError",
  "message": "Invalid `api_key` or `access_token`.",
  "status_code": 403
}
```

Common `error_type` values include:

*   `AuthenticationError`: Invalid credentials.
*   `InputValidationError` / `InputException`: Invalid parameters sent.
*   `OrderException`: Order placement/modification/cancellation issues (e.g., insufficient funds, RMS validation).
*   `NetworkError`: Connection issues, timeouts.
*   `RateLimitError`: Exceeded API rate limits.
*   `GeneralError`: Other Kite API errors.
*   `ServerError`: Unexpected errors within the MCP server or client.

## Disclaimer

Trading involves substantial risk. This software is provided "as is" without warranty of any kind. Use it at your own risk. The developers are not responsible for any financial losses incurred using this software.
